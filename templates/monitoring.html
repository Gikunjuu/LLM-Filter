{% extends "base.html" %}

{% block title %}Monitoring - Compliance Filter{% endblock %}

{% block extra_css %}
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    .page-header {
        margin-bottom: 32px;
    }
    
    .page-title {
        font-size: 32px;
        font-weight: 800;
        letter-spacing: -1px;
        margin-bottom: 8px;
        color: var(--gray-900);
    }
    
    .page-subtitle {
        font-size: 16px;
        color: var(--gray-500);
        font-weight: 400;
    }
    
    .monitoring-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .monitoring-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow);
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .monitoring-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
    }
    
    .monitoring-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 16px;
    }
    
    .monitoring-icon.primary { background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(0, 122, 255, 0.05) 100%); color: var(--primary); }
    .monitoring-icon.warning { background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%); color: var(--warning); }
    .monitoring-icon.danger { background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%); color: var(--danger); }
    .monitoring-icon.success { background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%); color: var(--success); }
    .monitoring-icon.info { background: linear-gradient(135deg, rgba(90, 200, 250, 0.1) 0%, rgba(90, 200, 250, 0.05) 100%); color: var(--info); }
    .monitoring-icon.secondary { background: linear-gradient(135deg, rgba(88, 86, 214, 0.1) 0%, rgba(88, 86, 214, 0.05) 100%); color: var(--secondary); }
    
    .monitoring-label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-500);
        margin-bottom: 8px;
    }
    
    .monitoring-value {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -1px;
        color: var(--gray-900);
    }
    
    .feed-container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 32px;
    }
    
    .feed-header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--gray-50);
    }
    
    .feed-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--gray-900);
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .feed-content {
        height: 500px;
        overflow-y: auto;
        padding: 16px;
    }
    
    .feed-item {
        padding: 20px;
        border-bottom: 1px solid var(--gray-100);
        border-left: 4px solid transparent;
        border-radius: var(--radius);
        margin-bottom: 12px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
    }
    
    .feed-item:hover {
        background: var(--gray-50);
        transform: translateX(4px);
    }
    
    [data-theme="dark"] .feed-item {
        background: var(--gray-100);
        border-bottom-color: var(--gray-200);
    }
    
    [data-theme="dark"] .feed-item:hover {
        background: var(--gray-200);
    }
    
    .feed-item.safe {
        border-left-color: var(--success);
    }
    
    .feed-item.violation {
        border-left-color: var(--danger);
    }
    
    .feed-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .feed-item-user {
        font-weight: 700;
        color: var(--gray-900);
        font-size: 14px;
    }
    
    .feed-item-time {
        font-size: 12px;
        color: var(--gray-500);
    }
    
    .feed-item-content {
        font-size: 14px;
        color: var(--gray-600);
        margin-bottom: 12px;
        line-height: 1.5;
    }
    
    .feed-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--gray-500);
    }
    
    .status-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow);
        margin-bottom: 24px;
    }
    
    .status-panel-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .innovation-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .innovation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--gray-50);
        border-radius: var(--radius);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .innovation-item:hover {
        background: white;
        box-shadow: var(--shadow-sm);
    }
    
    .threat-indicator {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto 16px;
        box-shadow: var(--shadow-md);
    }
    
    .threat-indicator.low {
        background: linear-gradient(135deg, var(--success) 0%, #30D158 100%);
        color: white;
    }
    
    .threat-indicator.medium {
        background: linear-gradient(135deg, var(--warning) 0%, #FF9F0A 100%);
        color: white;
    }
    
    .threat-indicator.high {
        background: linear-gradient(135deg, var(--danger) 0%, #FF453A 100%);
        color: white;
    }
    
    .empty-feed {
        text-align: center;
        padding: 64px 32px;
        color: var(--gray-400);
    }
    
    .empty-feed i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    </style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="page-title">Live Threat Monitoring</h1>
            <p class="page-subtitle">Real-time analysis and threat detection dashboard</p>
                </div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                <span style="font-size: 13px; color: var(--gray-500);">Live Feed Active</span>
            </div>
            <button class="btn-premium" id="toggle-refresh" onclick="toggleAutoRefresh()">
                <i class="bi bi-arrow-clockwise"></i>
                            <span id="refresh-status">Auto Refresh ON</span>
                        </button>
                    </div>
                </div>
            </div>

<!-- Real-time Stats -->
<div class="monitoring-stats">
    <div class="monitoring-card">
        <div class="monitoring-icon primary">
            <i class="bi bi-activity"></i>
        </div>
        <div class="monitoring-label">Live Status</div>
        <div class="monitoring-value" id="live-status">ACTIVE</div>
            </div>
            
    <div class="monitoring-card">
        <div class="monitoring-icon warning">
            <i class="bi bi-lightning-charge"></i>
                    </div>
        <div class="monitoring-label">Processing</div>
        <div class="monitoring-value" id="processing-count">0</div>
            </div>
            
    <div class="monitoring-card">
        <div class="monitoring-icon danger">
            <i class="bi bi-shield-exclamation"></i>
                    </div>
        <div class="monitoring-label">Threats</div>
        <div class="monitoring-value" id="threat-count">0</div>
            </div>
            
    <div class="monitoring-card">
        <div class="monitoring-icon success">
            <i class="bi bi-check-circle"></i>
                    </div>
        <div class="monitoring-label">Safe</div>
        <div class="monitoring-value" id="safe-count">0</div>
            </div>
            
    <div class="monitoring-card">
        <div class="monitoring-icon info">
            <i class="bi bi-speedometer2"></i>
                    </div>
        <div class="monitoring-label">Avg Time</div>
        <div class="monitoring-value" id="avg-time">--ms</div>
            </div>
            
    <div class="monitoring-card">
        <div class="monitoring-icon secondary">
            <i class="bi bi-graph-up"></i>
                    </div>
        <div class="monitoring-label">Rate</div>
        <div class="monitoring-value" id="analysis-rate">0/min</div>
            </div>
        </div>

        <!-- Main Monitoring Interface -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
            <!-- Real-time Feed -->
    <div class="feed-container">
        <div class="feed-header">
            <div class="feed-title">
                <i class="bi bi-broadcast" style="color: var(--primary);"></i>
                Real-time Analysis Feed
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span class="badge-premium" style="background: var(--gray-100); color: var(--gray-600);" id="feed-count">0 items</span>
                <button class="btn-premium" style="padding: 8px 16px; font-size: 13px;" onclick="clearFeed()">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </div>
        <div class="feed-content" id="real-time-feed">
            <div class="empty-feed">
                <i class="bi bi-broadcast"></i>
                                <div>Waiting for real-time analysis data...</div>
                                <small>Analysis results will appear here automatically</small>
                            </div>
                        </div>
                    </div>
    
    <!-- Sidebar -->
    <div>
        <!-- Innovation Systems Status -->
        <div class="status-panel">
            <div class="status-panel-title">
                <i class="bi bi-cpu" style="color: var(--primary);"></i>
                Innovation Systems
            </div>
            <div class="innovation-list" id="innovation-status">
                <div class="innovation-item">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">Adaptive Learning</span>
                    <span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">ACTIVE</span>
                    </div>
                <div class="innovation-item">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">Behavioral Analysis</span>
                    <span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">ACTIVE</span>
                            </div>
                <div class="innovation-item">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">Federated Learning</span>
                    <span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">ACTIVE</span>
                            </div>
                <div class="innovation-item">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">HuggingFace Transformers</span>
                    <span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">ACTIVE</span>
                            </div>
                <div class="innovation-item">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">Semantic Analysis</span>
                    <span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);">ACTIVE</span>
                        </div>
                    </div>
                </div>

                <!-- Threat Level Indicator -->
        <div class="status-panel" style="text-align: center;">
            <div class="status-panel-title" style="justify-content: center;">
                <i class="bi bi-shield-check" style="color: var(--primary);"></i>
                Current Threat Level
                    </div>
            <div class="threat-indicator low" id="threat-level-indicator">
                <i class="bi bi-shield-check"></i>
                            </div>
            <h5 style="margin-bottom: 8px; font-weight: 700;" id="threat-level-text">LOW</h5>
            <small style="color: var(--gray-500);">System operating normally</small>
                </div>

                <!-- Quick Actions -->
        <div class="status-panel">
            <div class="status-panel-title">
                <i class="bi bi-lightning-charge" style="color: var(--primary);"></i>
                Quick Actions
                    </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn-premium" style="width: 100%; justify-content: center;" onclick="exportThreatData()">
                    <i class="bi bi-download"></i>
                    Export Threat Data
                            </button>
                <button class="btn-premium" style="width: 100%; justify-content: center;" onclick="generateReport()">
                    <i class="bi bi-file-earmark-text"></i>
                    Generate Report
                            </button>
                <button class="btn-premium" style="width: 100%; justify-content: center;" onclick="systemHealthCheck()">
                    <i class="bi bi-heart-pulse"></i>
                    Health Check
                            </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
    
{% block scripts %}
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Monitoring state
        let autoRefresh = true;
        let analysisCount = 0;
        let threatCount = 0;
        let safeCount = 0;
        let processingTimes = [];
        let feedItems = [];
        
        // Initialize monitoring
        function initializeMonitoring() {
            updateCounters();
        setInterval(updateMetrics, 5000);
        }
        
        // Update counters
        function updateCounters() {
            document.getElementById('processing-count').textContent = analysisCount;
            document.getElementById('threat-count').textContent = threatCount;
            document.getElementById('safe-count').textContent = safeCount;
            document.getElementById('feed-count').textContent = feedItems.length + ' items';
            
            // Calculate average processing time
            if (processingTimes.length > 0) {
                const avgTime = processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length;
                document.getElementById('avg-time').textContent = avgTime.toFixed(1) + 'ms';
            }
            
        // Calculate analysis rate
        const rate = Math.min(analysisCount / 5, 99);
            document.getElementById('analysis-rate').textContent = rate.toFixed(0) + '/min';
            
            // Update threat level
            updateThreatLevel();
        }
        
        // Update threat level indicator
        function updateThreatLevel() {
            const indicator = document.getElementById('threat-level-indicator');
            const text = document.getElementById('threat-level-text');
            const percentage = threatCount > 0 ? (threatCount / analysisCount) * 100 : 0;
            
            if (percentage > 50) {
            indicator.className = 'threat-indicator high';
            indicator.innerHTML = '<i class="bi bi-shield-exclamation"></i>';
                text.textContent = 'HIGH';
            text.style.color = 'var(--danger)';
            } else if (percentage > 20) {
            indicator.className = 'threat-indicator medium';
            indicator.innerHTML = '<i class="bi bi-shield-check"></i>';
                text.textContent = 'MEDIUM';
            text.style.color = 'var(--warning)';
            } else {
            indicator.className = 'threat-indicator low';
            indicator.innerHTML = '<i class="bi bi-shield-check"></i>';
                text.textContent = 'LOW';
            text.style.color = 'var(--success)';
        }
    }
    
    // Add analysis to real-time feed
    function addToFeed(analysis) {
        const feed = document.getElementById('real-time-feed');
        
        // Clear waiting message if this is the first item
        if (feedItems.length === 0) {
            feed.innerHTML = '';
        }
        
        const timestamp = new Date(analysis.timestamp).toLocaleTimeString();
        const isViolation = analysis.result.status === 'VIOLATION';
        const statusClass = isViolation ? 'violation' : 'safe';
        const statusBadge = isViolation ? 
            '<span class="badge-premium" style="background: rgba(255, 59, 48, 0.1); color: var(--danger);"><i class="bi bi-exclamation-triangle"></i>VIOLATION</span>' :
            '<span class="badge-premium" style="background: rgba(52, 199, 89, 0.1); color: var(--success);"><i class="bi bi-check-circle"></i>SAFE</span>';
        
        const feedItem = document.createElement('div');
        feedItem.className = `feed-item ${statusClass}`;
        feedItem.innerHTML = `
            <div class="feed-item-header">
                <div>
                    <span class="feed-item-user">${analysis.user_id}</span>
                    ${statusBadge}
                </div>
                <span class="feed-item-time">${timestamp}</span>
            </div>
            <div class="feed-item-content">"${analysis.content_preview}"</div>
            <div class="feed-item-footer">
                <span>${analysis.processing_time.toFixed(1)}ms</span>
                ${analysis.result.confidence ? `<span>Confidence: ${(analysis.result.confidence * 100).toFixed(0)}%</span>` : ''}
            </div>
            ${analysis.result.reasoning ? `<div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius); font-size: 12px; color: var(--gray-600);"><strong>Reasoning:</strong> ${analysis.result.reasoning}</div>` : ''}
        `;
        
        feed.insertBefore(feedItem, feed.firstChild);
        feedItems.unshift(analysis);
        
        // Keep only last 50 items
        while (feedItems.length > 50) {
            feedItems.pop();
            if (feed.lastChild) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        // Update counters
        analysisCount++;
        if (isViolation) {
            threatCount++;
        } else {
            safeCount++;
        }
        processingTimes.push(analysis.processing_time || 0);
        
        // Keep processing times array manageable
        if (processingTimes.length > 100) {
            processingTimes = processingTimes.slice(-50);
        }
        
        updateCounters();
    }
    
    // Toggle auto refresh
    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        const status = document.getElementById('refresh-status');
        status.textContent = autoRefresh ? 'Auto Refresh ON' : 'Auto Refresh OFF';
    }
    
    // Clear feed
    function clearFeed() {
        const feed = document.getElementById('real-time-feed');
        feed.innerHTML = `
            <div class="empty-feed">
                <i class="bi bi-broadcast"></i>
                <div>Feed cleared - waiting for new analysis data...</div>
            </div>
        `;
        feedItems = [];
        updateCounters();
    }
    
    // Quick action functions
    function exportThreatData() {
        alert('Threat data export functionality would be implemented here');
    }
    
    function generateReport() {
        alert('Report generation functionality would be implemented here');
    }
    
    function systemHealthCheck() {
        alert('System health check functionality would be implemented here');
    }
    
    // Update metrics periodically
    function updateMetrics() {
        if (autoRefresh) {
            console.log('Updating metrics...');
        }
    }
    
    // Socket.IO event handlers
    socket.on('connect', function() {
        console.log('Connected to monitoring server');
        document.getElementById('live-status').textContent = 'ACTIVE';
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from monitoring server');
        document.getElementById('live-status').textContent = 'OFFLINE';
    });
    
    socket.on('new_analysis', function(analysis) {
        if (autoRefresh) {
            addToFeed(analysis);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeMonitoring();
    });
</script>
{% endblock %}